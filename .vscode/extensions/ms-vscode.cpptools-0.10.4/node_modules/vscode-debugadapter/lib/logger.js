/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fs = require('fs');
var debugSession_1 = require('./debugSession');
(function (LogLevel) {
    LogLevel[LogLevel["Verbose"] = 0] = "Verbose";
    LogLevel[LogLevel["Log"] = 1] = "Log";
    LogLevel[LogLevel["Error"] = 2] = "Error";
})(exports.LogLevel || (exports.LogLevel = {}));
var LogLevel = exports.LogLevel;
/** Logger singleton */
var _logger;
var _pendingLogQ = [];
function log(msg, forceLog, level) {
    if (forceLog === void 0) { forceLog = false; }
    if (level === void 0) { level = LogLevel.Log; }
    msg = msg + '\n';
    write(msg, forceLog, level);
}
exports.log = log;
function verbose(msg) {
    log(msg, undefined, LogLevel.Verbose);
}
exports.verbose = verbose;
function error(msg, forceLog) {
    if (forceLog === void 0) { forceLog = true; }
    log(msg, forceLog, LogLevel.Error);
}
exports.error = error;
/**
 * `log` adds a newline, this one doesn't
 */
function write(msg, forceLog, level) {
    if (forceLog === void 0) { forceLog = false; }
    if (level === void 0) { level = LogLevel.Log; }
    // [null, undefined] => string
    msg = msg + '';
    if (_pendingLogQ) {
        _pendingLogQ.push({ msg: msg, level: level });
    }
    else {
        _logger.log(msg, level, forceLog);
    }
}
/**
 * Set the logger's minimum level to log. Log messages are queued before this is
 * called the first time, because minLogLevel defaults to Error.
 */
function setMinLogLevel(logLevel) {
    if (_logger) {
        _logger.minLogLevel = logLevel;
        // Clear out the queue of pending messages
        if (_pendingLogQ) {
            var logQ = _pendingLogQ;
            _pendingLogQ = null;
            logQ.forEach(function (item) { return write(item.msg, undefined, item.level); });
        }
    }
}
exports.setMinLogLevel = setMinLogLevel;
function init(logCallback, logFilePath, logToConsole) {
    // Re-init, create new global Logger
    _pendingLogQ = [];
    _logger = new Logger(logCallback, logFilePath, logToConsole);
    if (logFilePath) {
        log("Verbose logs are written to:");
        log(logFilePath);
        var d = new Date();
        var timestamp = d.toLocaleTimeString() + ', ' + d.toLocaleDateString();
        verbose(timestamp);
    }
}
exports.init = init;
/**
 * Manages logging, whether to console.log, file, or VS Code console.
 */
var Logger = (function () {
    function Logger(logCallback, logFilePath, isServer) {
        this._logCallback = logCallback;
        this._logFilePath = logFilePath;
        this._logToConsole = isServer;
        this.minLogLevel = LogLevel.Error;
    }
    Object.defineProperty(Logger.prototype, "minLogLevel", {
        get: function () { return this._minLogLevel; },
        set: function (logLevel) {
            var _this = this;
            this._minLogLevel = logLevel;
            // Open a log file in the specified location. Overwritten on each run.
            if (logLevel < LogLevel.Error && this._logFilePath) {
                this._logFileStream = fs.createWriteStream(this._logFilePath);
                this._logFileStream.on('error', function (e) {
                    _this.sendLog("Error involving log file at path: " + _this._logFilePath + ". Error: " + e.toString(), LogLevel.Error);
                });
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param forceLog - Writes to the diagnostic logging channel, even if diagnostic logging is not enabled.
     *      (For messages that appear whether logging is enabled or not.)
     */
    Logger.prototype.log = function (msg, level, forceLog) {
        if (level >= this.minLogLevel || forceLog) {
            this.sendLog(msg, level);
        }
        if (this._logToConsole) {
            var logFn = level === LogLevel.Error ? console.error : console.log;
            logFn(trimLastNewline(msg));
        }
        // If an error, prepend with '[Error]'
        if (level === LogLevel.Error) {
            msg = "[" + LogLevel[level] + "] " + msg;
        }
        if (this._logFileStream) {
            this._logFileStream.write(msg);
        }
    };
    Logger.prototype.sendLog = function (msg, level) {
        // Truncate long messages, they can hang VS Code
        if (msg.length > 1500) {
            var endsInNewline = !!msg.match(/(\n|\r\n)$/);
            msg = msg.substr(0, 1500) + '[...]';
            if (endsInNewline) {
                msg = msg + '\n';
            }
        }
        if (this._logCallback) {
            var event_1 = new LogOutputEvent(msg, level);
            this._logCallback(event_1);
        }
    };
    return Logger;
}());
var LogOutputEvent = (function (_super) {
    __extends(LogOutputEvent, _super);
    function LogOutputEvent(msg, level) {
        _super.call(this, msg, level === LogLevel.Error ? 'stderr' : 'console');
    }
    return LogOutputEvent;
}(debugSession_1.OutputEvent));
exports.LogOutputEvent = LogOutputEvent;
function trimLastNewline(str) {
    return str.replace(/(\n|\r\n)$/, '');
}
exports.trimLastNewline = trimLastNewline;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvZ2dlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7NERBRTREOzs7Ozs7O0FBRTVELElBQVksRUFBRSxXQUFNLElBQUksQ0FBQyxDQUFBO0FBQ3pCLDZCQUEwQixnQkFBZ0IsQ0FBQyxDQUFBO0FBRTNDLFdBQVksUUFBUTtJQUNuQiw2Q0FBVyxDQUFBO0lBQ1gscUNBQU8sQ0FBQTtJQUNQLHlDQUFTLENBQUE7QUFDVixDQUFDLEVBSlcsZ0JBQVEsS0FBUixnQkFBUSxRQUluQjtBQUpELElBQVksUUFBUSxHQUFSLGdCQUlYLENBQUE7QUFTRCx1QkFBdUI7QUFDdkIsSUFBSSxPQUFlLENBQUM7QUFDcEIsSUFBSSxZQUFZLEdBQWUsRUFBRSxDQUFDO0FBQ2xDLGFBQW9CLEdBQVcsRUFBRSxRQUFnQixFQUFFLEtBQW9CO0lBQXRDLHdCQUFnQixHQUFoQixnQkFBZ0I7SUFBRSxxQkFBb0IsR0FBcEIsUUFBUSxRQUFRLENBQUMsR0FBRztJQUN0RSxHQUFHLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQztJQUNqQixLQUFLLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBSGUsV0FBRyxNQUdsQixDQUFBO0FBRUQsaUJBQXdCLEdBQVc7SUFDbEMsR0FBRyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFGZSxlQUFPLFVBRXRCLENBQUE7QUFFRCxlQUFzQixHQUFXLEVBQUUsUUFBZTtJQUFmLHdCQUFlLEdBQWYsZUFBZTtJQUNqRCxHQUFHLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUZlLGFBQUssUUFFcEIsQ0FBQTtBQUVEOztHQUVHO0FBQ0gsZUFBZSxHQUFXLEVBQUUsUUFBZ0IsRUFBRSxL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YUFBYSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ2hELEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDcEMsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztnQkFDbkIsR0FBRyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7WUFDbEIsQ0FBQztRQUNGLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUN2QixJQUFNLE9BQUssR0FBRyxJQUFJLGNBQWMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFLLENBQUMsQ0FBQztRQUMxQixDQUFDO0lBQ0YsQ0FBQztJQUNGLGFBQUM7QUFBRCxDQUFDLEFBMUVELElBMEVDO0FBRUQ7SUFBb0Msa0NBQVc7SUFDOUMsd0JBQVksR0FBVyxFQUFFLEtBQWU7UUFDdkMsa0JBQU0sR0FBRyxFQUFFLEtBQUssS0FBSyxRQUFRLENBQUMsS0FBSyxHQUFHLFFBQVEsR0FBRyxTQUFTLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBQ0YscUJBQUM7QUFBRCxDQUFDLEFBSkQsQ0FBb0MsMEJBQVcsR0FJOUM7QUFKWSxzQkFBYyxpQkFJMUIsQ0FBQTtBQUVELHlCQUFnQyxHQUFXO0lBQzFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztBQUN0QyxDQUFDO0FBRmUsdUJBQWUsa0JBRTlCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogQ29weXJpZ2h0IChDKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHtPdXRwdXRFdmVudH0gZnJvbSAnLi9kZWJ1Z1Nlc3Npb24nO1xuXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG5cdFZlcmJvc2UgPSAwLFxuXHRMb2cgPSAxLFxuXHRFcnJvciA9IDJcbn1cblxuZXhwb3J0IHR5cGUgSUxvZ0NhbGxiYWNrID0gKG91dHB1dEV2ZW50OiBPdXRwdXRFdmVudCkgPT4gdm9pZDtcblxuaW50ZXJmYWNlIElMb2dJdGVtIHtcblx0bXNnOiBzdHJpbmc7XG5cdGxldmVsOiBMb2dMZXZlbDtcbn1cblxuLyoqIExvZ2dlciBzaW5nbGV0b24gKi9cbmxldCBfbG9nZ2VyOiBMb2dnZXI7XG5sZXQgX3BlbmRpbmdMb2dROiBJTG9nSXRlbVtdID0gW107XG5leHBvcnQgZnVuY3Rpb24gbG9nKG1zZzogc3RyaW5nLCBmb3JjZUxvZyA9IGZhbHNlLCBsZXZlbCA9IExvZ0xldmVsLkxvZyk6IHZvaWQge1xuXHRtc2cgPSBtc2cgKyAnXFxuJztcblx0d3JpdGUobXNnLCBmb3JjZUxvZywgbGV2ZWwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdmVyYm9zZShtc2c6IHN0cmluZyk6IHZvaWQge1xuXHRsb2cobXNnLCB1bmRlZmluZWQsIExvZ0xldmVsLlZlcmJvc2UpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXJyb3IobXNnOiBzdHJpbmcsIGZvcmNlTG9nID0gdHJ1ZSk6IHZvaWQge1xuXHRsb2cobXNnLCBmb3JjZUxvZywgTG9nTGV2ZWwuRXJyb3IpO1xufVxuXG4vKipcbiAqIGBsb2dgIGFkZHMgYSBuZXdsaW5lLCB0aGlzIG9uZSBkb2Vzbid0XG4gKi9cbmZ1bmN0aW9uIHdyaXRlKG1zZzogc3RyaW5nLCBmb3JjZUxvZyA9IGZhbHNlLCBsZXZlbCA9IExvZ0xldmVsLkxvZyk6IHZvaWQge1xuXHQvLyBbbnVsbCwgdW5kZWZpbmVkXSA9PiBzdHJpbmdcblx0bXNnID0gbXNnICsgJyc7XG5cdGlmIChfcGVuZGluZ0xvZ1EpIHtcblx0XHRfcGVuZGluZ0xvZ1EucHVzaCh7IG1zZywgbGV2ZWwgfSk7XG5cdH0gZWxzZSB7XG5cdFx0X2xvZ2dlci5sb2cobXNnLCBsZXZlbCwgZm9yY2VMb2cpO1xuXHR9XG59XG5cbi8qKlxuICogU2V0IHRoZSBsb2dnZXIncyBtaW5pbXVtIGxldmVsIHRvIGxvZy4gTG9nIG1lc3NhZ2VzIGFyZSBxdWV1ZWQgYmVmb3JlIHRoaXMgaXNcbiAqIGNhbGxlZCB0aGUgZmlyc3QgdGltZSwgYmVjYXVzZSBtaW5Mb2dMZXZlbCBkZWZhdWx0cyB0byBFcnJvci5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldE1pbkxvZ0xldmVsKGxvZ0xldmVsOiBMb2dMZXZlbCk6IHZvaWQge1xuXHRpZiAoX2xvZ2dlcikge1xuXHRcdF9sb2dnZXIubWluTG9nTGV2ZWwgPSBsb2dMZXZlbDtcblxuXHRcdC8vIENsZWFyIG91dCB0aGUgcXVldWUgb2YgcGVuZGluZyBtZXNzYWdlc1xuXHRcdGlmIChfcGVuZGluZ0xvZ1EpIHtcblx0XHRcdGNvbnN0IGxvZ1EgPSBfcGVuZGluZ0xvZ1E7XG5cdFx0XHRfcGVuZGluZ0xvZ1EgPSBudWxsO1xuXHRcdFx0bG9nUS5mb3JFYWNoKGl0ZW0gPT4gd3JpdGUoaXRlbS5tc2csIHVuZGVmaW5lZCwgaXRlbS5sZXZlbCkpO1xuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdChsb2dDYWxsYmFjazogSUxvZ0NhbGxiYWNrLCBsb2dGaWxlUGF0aD86IHN0cmluZywgbG9nVG9Db25zb2xlPzogYm9vbGVhbik6IHZvaWQge1xuXHQvLyBSZS1pbml0LCBjcmVhdGUgbmV3IGdsb2JhbCBMb2dnZXJcblx0X3BlbmRpbmdMb2dRID0gW107XG5cdF9sb2dnZXIgPSBuZXcgTG9nZ2VyKGxvZ0NhbGxiYWNrLCBsb2dGaWxlUGF0aCwgbG9nVG9Db25zb2xlKTtcblx0aWYgKGxvZ0ZpbGVQYXRoKSB7XG5cdFx0bG9nKGBWZXJib3NlIGxvZ3MgYXJlIHdyaXR0ZW4gdG86YCk7XG5cdFx0bG9nKGxvZ0ZpbGVQYXRoKTtcblxuXHRcdGNvbnN0IGQgPSBuZXcgRGF0ZSgpO1xuXHRcdGNvbnN0IHRpbWVzdGFtcCA9IGQudG9Mb2NhbGVUaW1lU3RyaW5nKCkgKyAnLCAnICsgZC50b0xvY2FsZURhdGVTdHJpbmcoKTtcblx0XHR2ZXJib3NlKHRpbWVzdGFtcCk7XG5cdH1cbn1cblxuLyoqXG4gKiBNYW5hZ2VzIGxvZ2dpbmcsIHdoZXRoZXIgdG8gY29uc29sZS5sb2csIGZpbGUsIG9yIFZTIENvZGUgY29uc29sZS5cbiAqL1xuY2xhc3MgTG9nZ2VyIHtcblx0LyoqIFRoZSBwYXRoIG9mIHRoZSBsb2cgZmlsZSAqL1xuXHRwcml2YXRlIF9sb2dGaWxlUGF0aDogc3RyaW5nO1xuXG5cdHByaXZhdGUgX21pbkxvZ0xldmVsOiBMb2dMZXZlbDtcblx0cHJpdmF0ZSBfbG9nVG9Db25zb2xlOiBib29sZWFuO1xuXG5cdC8qKiBMb2cgaW5mbyB0aGF0IG1lZXRzIG1pbkxvZ0xldmVsIGlzIHNlbnQgdG8gdGhpcyBjYWxsYmFjay4gKi9cblx0cHJpdmF0ZSBfbG9nQ2FsbGJhY2s6IElMb2dDYWxsYmFjaztcblxuXHQvKiogV3JpdGUgc3RlYW0gZm9yIGxvZyBmaWxlICovXG5cdHByaXZhdGUgX2xvZ0ZpbGVTdHJlYW06IGZzLldyaXRlU3RyZWFtO1xuXG5cdHB1YmxpYyBnZXQgbWluTG9nTGV2ZWwoKTogTG9nTGV2ZWwgeyByZXR1cm4gdGhpcy5fbWluTG9nTGV2ZWw7IH1cblxuXHRwdWJsaWMgc2V0IG1pbkxvZ0xldmVsKGxvZ0xldmVsOiBMb2dMZXZlbCkge1xuXHRcdHRoaXMuX21pbkxvZ0xldmVsID0gbG9nTGV2ZWw7XG5cblx0XHQvLyBPcGVuIGEgbG9nIGZpbGUgaW4gdGhlIHNwZWNpZmllZCBsb2NhdGlvbi4gT3ZlcndyaXR0ZW4gb24gZWFjaCBydW4uXG5cdFx0aWYgKGxvZ0xldmVsIDwgTG9nTGV2ZWwuRXJyb3IgJiYgdGhpcy5fbG9nRmlsZVBhdGgpIHtcblx0XHRcdHRoaXMuX2xvZ0ZpbGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSh0aGlzLl9sb2dGaWxlUGF0aCk7XG5cdFx0XHR0aGlzLl9sb2dGaWxlU3RyZWFtLm9uKCdlcnJvcicsIGUgPT4ge1xuXHRcdFx0XHR0aGlzLnNlbmRMb2coYEVycm9yIGludm9sdmluZyBsb2cgZmlsZSBhdCBwYXRoOiAke3RoaXMuX2xvZ0ZpbGVQYXRofS4gRXJyb3I6ICR7ZS50b1N0cmluZygpfWAsIExvZ0xldmVsLkVycm9yKTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdGNvbnN0cnVjdG9yKGxvZ0NhbGxiYWNrOiBJTG9nQ2FsbGJhY2ssIGxvZ0ZpbGVQYXRoPzogc3RyaW5nLCBpc1NlcnZlcj86IGJvb2xlYW4pIHtcblx0XHR0aGlzLl9sb2dDYWxsYmFjayA9IGxvZ0NhbGxiYWNrO1xuXHRcdHRoaXMuX2xvZ0ZpbGVQYXRoID0gbG9nRmlsZVBhdGg7XG5cdFx0dGhpcy5fbG9nVG9Db25zb2xlID0gaXNTZXJ2ZXI7XG5cblx0XHR0aGlzLm1pbkxvZ0xldmVsID0gTG9nTGV2ZWwuRXJyb3I7XG5cdH1cblxuXHQvKipcblx0ICogQHBhcmFtIGZvcmNlTG9nIC0gV3JpdGVzIHRvIHRoZSBkaWFnbm9zdGljIGxvZ2dpbmcgY2hhbm5lbCwgZXZlbiBpZiBkaWFnbm9zdGljIGxvZ2dpbmcgaXMgbm90IGVuYWJsZWQuXG5cdCAqICAgICAgKEZvciBtZXNzYWdlcyB0aGF0IGFwcGVhciB3aGV0aGVyIGxvZ2dpbmcgaXMgZW5hYmxlZCBvciBub3QuKVxuXHQgKi9cblx0cHVibGljIGxvZyhtc2c6IHN0cmluZywgbGV2ZWw6IExvZ0xldmVsLCBmb3JjZUxvZzogYm9vbGVhbik6IHZvaWQge1xuXHRcdGlmIChsZXZlbCA+PSB0aGlzLm1pbkxvZ0xldmVsIHx8IGZvcmNlTG9nKSB7XG5cdFx0XHR0aGlzLnNlbmRMb2cobXNnLCBsZXZlbCk7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX2xvZ1RvQ29uc29sZSkge1xuXHRcdFx0Y29uc3QgbG9nRm4gPSBsZXZlbCA9PT0gTG9nTGV2ZWwuRXJyb3IgPyBjb25zb2xlLmVycm9yIDogY29uc29sZS5sb2c7XG5cdFx0XHRsb2dGbih0cmltTGFzdE5ld2xpbmUobXNnKSk7XG5cdFx0fVxuXG5cdFx0Ly8gSWYgYW4gZXJyb3IsIHByZXBlbmQgd2l0aCAnW0Vycm9yXSdcblx0XHRpZiAobGV2ZWwgPT09IExvZ0xldmVsLkVycm9yKSB7XG5cdFx0XHRtc2cgPSBgWyR7TG9nTGV2ZWxbbGV2ZWxdfV0gJHttc2d9YDtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fbG9nRmlsZVN0cmVhbSkge1xuXHRcdFx0dGhpcy5fbG9nRmlsZVN0cmVhbS53cml0ZShtc2cpO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgc2VuZExvZyhtc2c6IHN0cmluZywgbGV2ZWw6IExvZ0xldmVsKTogdm9pZCB7XG5cdFx0Ly8gVHJ1bmNhdGUgbG9uZyBtZXNzYWdlcywgdGhleSBjYW4gaGFuZyBWUyBDb2RlXG5cdFx0aWYgKG1zZy5sZW5ndGggPiAxNTAwKSB7XG5cdFx0XHRjb25zdCBlbmRzSW5OZXdsaW5lID0gISFtc2cubWF0Y2goLyhcXG58XFxyXFxuKSQvKTtcblx0XHRcdG1zZyA9IG1zZy5zdWJzdHIoMCwgMTUwMCkgKyAnWy4uLl0nO1xuXHRcdFx0aWYgKGVuZHNJbk5ld2xpbmUpIHtcblx0XHRcdFx0bXNnID0gbXNnICsgJ1xcbic7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX2xvZ0NhbGxiYWNrKSB7XG5cdFx0XHRjb25zdCBldmVudCA9IG5ldyBMb2dPdXRwdXRFdmVudChtc2csIGxldmVsKTtcblx0XHRcdHRoaXMuX2xvZ0NhbGxiYWNrKGV2ZW50KTtcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGNsYXNzIExvZ091dHB1dEV2ZW50IGV4dGVuZHMgT3V0cHV0RXZlbnQge1xuXHRjb25zdHJ1Y3Rvcihtc2c6IHN0cmluZywgbGV2ZWw6IExvZ0xldmVsKSB7XG5cdFx0c3VwZXIobXNnLCBsZXZlbCA9PT0gTG9nTGV2ZWwuRXJyb3IgPyAnc3RkZXJyJyA6ICdjb25zb2xlJyk7XG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyaW1MYXN0TmV3bGluZShzdHI6IHN0cmluZyk6IHN0cmluZyB7XG5cdHJldHVybiBzdHIucmVwbGFjZSgvKFxcbnxcXHJcXG4pJC8sICcnKTtcbn1cbiJdfQ==